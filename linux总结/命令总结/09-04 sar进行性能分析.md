# 09-04 sar进行性能分析

[TOC]

## sar介绍

sar是System Activity Reporter（系统活动情况报告）的缩写。sar工具将对系统当前的状态进行取样，然后通过计算数据和比例来表达系统的当前运行状态。它的特点是可以连续对系统取样，获得大量的取样数据；取样数据和分析的结果都可以存入文件，所需的负载很小。sar是目前Linux上最为全面的系统性能分析工具之一，可以从14个大方面对系统的活动进行报告，包括文件的读写情况、系统调用的使用情况、串口、CPU效率、内存使用状况、进程活动及IPC有关的活动等，使用也是较为复杂。

sar是查看操作系统报告指标的各种工具中，最为普遍和方便的；它有两种用法；

追溯过去的统计数据（默认）
周期性的查看当前数据

## SAR常用参数

- -b：报告I/O使用情况以及传输速率。（只适用于2.5及之前的内核，所以新内核有可能不支持这个选项）

- -B：报告“页”使用情况

- -c：报告进程创建情况

- -d：报告每一个块设备的使用情况
  （当你使用时，你会发现在DEV列有类似dev1-7格式的字符串，
  其中1代表设备的主序号，n代表设备的从序号，
  而且rd_sec/s列和wr_sec/s列的单位都是512bytes，也就是512B，也就是0.5KB）

- -I：汇报中断情况

- -n：汇报网络情况

- -P：设定CPU

- -q：汇报队列长度和负载信息

- -r：汇报内存和交换区使用情况

- -R：汇报内存情况

- -u：汇报CPU使用情况

- -v：汇报i节点、文件和其他内核表信息

- -w：汇报系统上下文切换情况

- -x：可以针对某个特定PID给出统计信息，

  可以直接指定进程ID号；
  也可以指定为SELF，这样就是检测sar进程本身；
  如果设定为ALL，则表示汇报所有系统进程信息。

- -X：汇报特定PID的子进程的信息

- -y：设定TTY设备的信息。

## SAR使用实例

### 查看平均负载

```
sar -q
```

指定-q后，就能查看运行队列中的进程数、系统上的进程大小、平均负载等；与其它命令相比，它能查看各项指标随时间变化的情况；

```bash
# sar -q 1 5
Linux 3.10.0-693.el7.x86_64 (operation_server.pycf) 	2018年12月19日 	_x86_64_	(48 CPU)

00时17分56秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
00时17分57秒         0     15459      6.21      7.44      8.16         0
00时17分58秒         3     15459      6.21      7.44      8.16         0
00时17分59秒         4     15464      6.21      7.44      8.16         0
00时18分00秒         3     15464      6.21      7.44      8.16         0
00时18分01秒        31     15573      6.21      7.44      8.16         0
平均时间:         8     15484      6.21      7.44      8.16         0
```



- runq-sz：运行队列的长度（等待运行的进程数）
- plist-sz：进程列表中进程（processes）和线程（threads）的数量
- ldavg-1：最后1分钟的系统平均负载
- ldavg-5：过去5分钟的系统平均负载
- ldavg-15：过去15分钟的系统平均负载

 

### 使用sar查看指定时间、指定日期的历史记录

- 使用参数-s和-e限定查看的时间, -s 代表时间之后， -e代表时间之前

```
# sar -s 20:00:00
Linux 3.13.0-55-generic (ISeR-Server1)     08/12/2015     _x86_64_    (4 CPU)

08:05:01 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
08:15:01 PM     all      3.98      0.02      6.07      0.58      0.00     89.34
08:25:01 PM     all      4.32      0.02      5.74      0.58      0.00     89.34
Average:        all      4.15      0.02      5.91      0.58      0.00     89.34
```

 只查看当天20:00:00后的CPU统计记录

 

- 使用参数-f查看本月内之前某一天的历史统计信息

```
# sar -d -p  -f /var/log/sa/sa18 -e 01:00:00
Linux 3.10.0-693.el7.x86_64 (operation_server.pycf) 	2018年12月18日 	_x86_64_	(48 CPU)

00时00分01秒       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
00时10分01秒       sda    101.80      7.72   2545.80     25.08      0.04      0.40      0.20      2.00
00时10分01秒       sdb    148.62   1182.74   5400.25     44.29      0.25      1.68      0.39      5.80
00时20分01秒       sda    101.24     12.27   2535.22     25.16      0.05      0.52      0.24      2.39
00时20分01秒       sdb    998.30  13891.65  33245.27     47.22      9.98      9.99      0.57     56.81
00时30分01秒       sda    100.79      7.48   2516.20     25.04      0.05      0.47      0.22      2.24
00时30分01秒       sdb    204.07   1953.16   7717.33     47.39      0.27      1.32      0.27      5.42
00时40分02秒       sda    102.18     22.56   2533.05     25.01      0.05      0.46      0.21      2.16
00时40分02秒       sdb    385.06   4858.02  12895.43     46.11      1.01      2.62      0.66     25.42
00时50分01秒       sda    100.92      5.75   2522.17     25.05      0.04      0.37      0.20      2.04
00时50分01秒       sdb      1.24      0.00     32.49     26.16      0.00      0.11      0.04      0.01

平均时间:       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
平均时间:       sda    101.39     11.15   2530.49     25.07      0.05      0.44      0.21      2.17
平均时间:       sdb    347.36   4375.54  11855.03     46.73      2.30      6.62      0.54     18.68
```

 　　sysstat工具只存储1个月内的系统使用记录，每天的记录以saN为文件名保存在相应的日志目录中，这里我们查看本月8号的CPU使用记录。

 

### CPU利用率查看
```
sar -p （默认查看为当天）
sar -u 1 5 （每隔一秒写入5次）
```

```
# sar -p
Linux 3.10.0-693.el7.x86_64 (operation_server.pycf) 	2018年12月19日 	_x86_64_	(48 CPU)

00时00分01秒     CPU     %user     %nice   %system   %iowait    %steal     %idle
00时10分01秒     all      6.18      0.00      8.57      0.28      0.00     84.96
00时20分02秒     all      4.90      0.00      8.64      1.67      0.00     84.79
00时30分01秒     all      4.95      0.00      8.41      1.40      0.00     85.24
```

输出项说明：
CPU all 表示统计信息为所有 CPU 的平均值。

- %user 显示在用户级别(application)运行使用 CPU 总时间的百分比。
- %nice 显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。
- %system 在核心级别(kernel)运行所使用 CPU 总时间的百分比。
- %iowait 显示用于等待I/O操作占用 CPU 总时间的百分比。
- %steal 管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。
- %idle 显示 CPU 空闲时间占用 CPU 总时间的百分比。

**注意：**

1. 若 %iowait 的值过高，表示硬盘存在I/O瓶颈
2. 若 %idle 的值高系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量
3.  若 %idle 的值持续低于 10，则系统的 CPU 处理能力相对较低，表明系统中最需要解决的资源是 CPU。

### 内存利用率查看

```
sar -r 1 10
vmstat 1 10
```

```
# sar -r 1 10
Linux 3.10.0-693.el7.x86_64 (operation_server.pycf) 	2018年12月19日 	_x86_64_	(48 CPU)

00时32分47秒 kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
00时32分48秒   5341568 126404296     95.95         0  26303676 221988420    141.47  57898616  62796552      1604
00时32分49秒   5322768 126423096     95.96         0  26303772 221989080    141.47  57917068  62796512      1608
00时32分50秒   5291080 126454784     95.98         0  26303868 222673804    141.91  57928996  62796644      1584

```



- kbmemused：这个值和free命令中的used值基本一致,所以它包括buffer和cache的空间.
- kbmemfree：这个值和free命令中的free值基本一致,所以它不包括buffer和cache的空间.
- %memused：物理内存使用率，这个值是kbmemused和内存总量(不包括swap)的一个百分比.
- kbbuffers和kbcached：这两个值就是free命令中的buffer和cache.
- kbcommit：保证当前系统所需要的内存,即为了确保不溢出而需要的内存(RAM+swap).
- %commit：这个值是kbcommit与内存总量(包括swap)的一个百分比.

```
# vmstat 1 4
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  5 5788160 5240524      0 29564848    0    0    11    40    0    0  4  6 90  0  0
 2  5 5788160 5242656      0 29565104    0    0 11536 45259 18982 19315  1  1 90  8  0
10  4 5788160 5197424      0 29565724    0    0 24480 37190 22806 27146  2  2 91  6  0
 7  4 5788160 5214660      0 29566204    0    0 19104 66738 127412 308102 20 45 32  3  0
```

可用内存=free+buffers+cached 已用内存：userd-buffers-cached

### 磁盘I/O使用情况查看

```
iostat -x 1 10
等同于sar -d 1 10
```

```
# sar -d -p 1 10
Linux 3.10.0-693.el7.x86_64 (operation_server.pycf) 	2018年12月19日 	_x86_64_	(48 CPU)

00时35分48秒       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
00时35分49秒       sda      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
00时35分49秒       sdb   1029.00  16992.00  28523.00     44.23      5.05      4.91      0.97    100.20

00时35分49秒       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
00时35分50秒       sda    188.00      0.00   4974.00     26.46      0.04      0.20      0.15      2.80
00时35分50秒       sdb    958.00  14784.00  27791.00     44.44      5.04      4.18      1.04     99.90
```

参数-p可以打印出sda,hdc等磁盘设备名称,如果不用参数-p,设备节点则有可能是dev8-0,dev22-0

- tps:每秒从物理磁盘I/O的次数.多个逻辑请求会被合并为一个I/O磁盘请求,一次传输的大小是不确定的.

- rd_sec/s:每秒读扇区的次数.

- wr_sec/s:每秒写扇区的次数 

- avgrq-sz:平均每次设备I/O操作的数据大小(扇区).

- avgqu-sz:磁盘请求队列的平均长度.

- await表示平均每次设备I/O操作的等待时间（以毫秒为单位）。 

- svctm表示平均每次设备I/O操作的服务时间（以毫秒为单位）。

- %util表示一秒中有百分之几的时间用于I/O操作。 


**对以磁盘IO性能，一般有如下评判标准：**
- 正常情况下svctm应该是小于await值的，而svctm的大小和磁盘性能有关，CPU、内存的负荷也会对svctm值造成影响，过多的请求也会间接的导致svctm值的增加。

- await值的大小一般取决与svctm的值和I/O队列长度以及I/O请求模式，如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢，此时可以通过更换更快的硬盘来解决问题。

- %util项的值也是衡量磁盘I/O的一个重要指标，如果%util接近100%，表示磁盘产生的I/O请求太多，I/O系统已经满负荷的在工作，该磁盘可能存在瓶颈。长期下去，势必影响系统的性能，可以通过优化程序或者通过更换更高、更快的磁盘来解决此问题。


### 网络流量情况分析
```
sar -n DEV
```

```
$ sar -n DEV 1 2
Linux 2.6.32-642.4.2.el6.x86_64 (System2.pycf)  2018年12月19日  _x86_64_        (4 CPU)

10时07分21秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s
10时07分22秒        lo    157.58    157.58     10.71     10.71      0.00      0.00      0.00
10时07分22秒      eth0   1463.64   1380.81    913.80    232.80      0.00      0.00      0.00
10时07分22秒      eth1      0.00      0.00      0.00      0.00      0.00      0.00      0.00

10时07分22秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s
10时07分23秒        lo    157.58    157.58     10.71     10.71      0.00      0.00      0.00
10时07分23秒      eth0   1571.72   1535.35    901.76    253.29      0.00      0.00      0.00
10时07分23秒      eth1      0.00      0.00      0.00      0.00      0.00      0.00      0.00
```


sar命令使用-n选项可以汇报网络相关信息，可用的参数包括：DEV、EDEV、SOCK和FULL。

如果你使用DEV关键字，那么sar将汇报和网络设备相关的信息，如lo，eth0或eth1等，例如：

- IFACE：就是网络设备的名称；
- rxpck/s：每秒钟接收到的包数目
- txpck/s：每秒钟发送出去的包数目
- rxbyt/s：每秒钟接收到的字节数
- txbyt/s：每秒钟发送出去的字节数
- rxcmp/s：每秒钟接收到的压缩包数目
- txcmp/s：每秒钟发送出去的压缩包数目
- txmcst/s：每秒钟接收到的多播包的包数目

如果你使用SOCK关键字，则会针对socket连接进行汇报，例如：

```
# sar -n SOCK 1 3
Linux 3.10.0-693.el7.x86_64 (operation_server.pycf) 	2018年12月19日 	_x86_64_	(48 CPU)

00时40分59秒    totsck    tcpsck    udpsck    rawsck   ip-frag    tcp-tw
00时41分00秒     96150        90         2         0         0         8
00时41分01秒     96159        92         2         0         0         7
00时41分02秒     96159        92         2         0         0         6
平均时间:     96156        91         2         0         0         7
```

- tcpsck：当前正在被使用于TCP的socket数目
- udpsck：当前正在被使用于UDP的socket数目
- rawsck：当前正在被使用于RAW的socket数目
- ip-frag：当前的IP分片的数目

如果你使用FULL关键字，相当于上述DEV、EDEV和SOCK三者的综合。

### 让sar输出到文件并在某个特定时间结束

```
sar -e 15:00:00 1 -o cpu.sa
```
每隔1秒记录CPU的使用情况，直到15点，数据将保存到cpu.sa文件中。(-e 参数表示结束时间，注意时间格式：必须为hh:mm:ss格式)

```
sar -e 15:00:00 1 -o mem.sa
```
每隔1秒记录内存使用情况，直到15点，数据将保存到mem.sa文件中。

```
sar -e 15:00:00 1 -o net.sa
```
每隔1秒记录网络使用情况，直到15点，数据将保存到net.sa文件中。

- 查看文件
```
sar -f <文件名>
```



## 总结 

要判断系统瓶颈问题，有时需几个 sar 命令选项结合起来
怀疑CPU存在瓶颈，可用 sar -u 和 sar -q 等来查看
怀疑内存存在瓶颈，可用 sar -B、sar -r 和 sar -W 等来查看
怀疑I/O存在瓶颈，可用 sar -b、sar -u 和 sar -d 等来查看